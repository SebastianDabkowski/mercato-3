@page
@model MercatoApp.Pages.Admin.Returns.IndexModel
@{
    ViewData["Title"] = "Returns & Disputes - Admin";
}

<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="mb-3">
                <i class="bi bi-shield-check"></i> Returns & Disputes
            </h1>
            <p class="text-muted">
                Admin view of all return and complaint requests across all stores
            </p>
            <a asp-page="/Admin/Returns/SLADashboard" class="btn btn-outline-primary">
                <i class="bi bi-graph-up"></i> View SLA Dashboard
            </a>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-title text-muted">Pending Review</h6>
                    <h3 class="mb-0">@Model.ReturnRequests.Count(r => r.Status == MercatoApp.Models.ReturnStatus.Requested)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-dark">
                <div class="card-body">
                    <h6 class="card-title text-muted">Under Admin Review</h6>
                    <h3 class="mb-0">@Model.ReturnRequests.Count(r => r.Status == MercatoApp.Models.ReturnStatus.UnderAdminReview)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-title text-muted">Approved</h6>
                    <h3 class="mb-0">@Model.ReturnRequests.Count(r => r.Status == MercatoApp.Models.ReturnStatus.Approved)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-title text-muted">Resolved/Completed</h6>
                    <h3 class="mb-0">@Model.ReturnRequests.Count(r => r.Status == MercatoApp.Models.ReturnStatus.Resolved || r.Status == MercatoApp.Models.ReturnStatus.Completed)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-muted">Response SLA Breach</h6>
                    <h3 class="mb-0 text-danger">@Model.ReturnRequests.Count(r => r.FirstResponseSLABreached)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-muted">Resolution SLA Breach</h6>
                    <h3 class="mb-0 text-danger">@Model.ReturnRequests.Count(r => r.ResolutionSLABreached)</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Search & Filter Cases
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search (Case #, Buyer, Seller)</label>
                    <input type="text" name="SearchQuery" class="form-control" value="@Model.SearchQuery" placeholder="Search..." />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="StatusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.Requested)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.Requested)">Pending Review</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.UnderAdminReview)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.UnderAdminReview)">Under Admin Review</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.Approved)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.Approved)">Approved</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.Rejected)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.Rejected)">Rejected</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.Completed)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.Completed)">Completed</option>
                        <option value="@((int)MercatoApp.Models.ReturnStatus.Resolved)" selected="@(Model.StatusFilter == MercatoApp.Models.ReturnStatus.Resolved)">Resolved</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select name="TypeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="@((int)MercatoApp.Models.ReturnRequestType.Return)" selected="@(Model.TypeFilter == MercatoApp.Models.ReturnRequestType.Return)">Return</option>
                        <option value="@((int)MercatoApp.Models.ReturnRequestType.Complaint)" selected="@(Model.TypeFilter == MercatoApp.Models.ReturnRequestType.Complaint)">Complaint</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Store</label>
                    <select name="StoreFilter" class="form-select">
                        <option value="">All Stores</option>
                        @foreach (var store in Model.AvailableStores)
                        {
                            <option value="@store.Id" selected="@(Model.StoreFilter == store.Id)">@store.StoreName</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results -->
    @if (!Model.ReturnRequests.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No return requests found matching the selected filters.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list"></i> Return Requests (@Model.ReturnRequests.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Case #</th>
                                <th>Type</th>
                                <th>Store</th>
                                <th>Buyer Alias</th>
                                <th>Status</th>
                                <th>SLA Status</th>
                                <th>Age</th>
                                <th>Refund Amount</th>
                                <th>Messages</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.ReturnRequests)
                            {
                                var requestTypeLabel = request.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "Complaint" : "Return";
                                var requestIcon = request.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "exclamation-triangle" : "arrow-return-left";
                                var messageCount = request.Messages?.Count ?? 0;
                                var caseAge = (DateTime.UtcNow - request.RequestedAt).Days;
                                var buyerAlias = !string.IsNullOrEmpty(request.Buyer.LastName) && request.Buyer.LastName.Length > 0
                                    ? $"{request.Buyer.FirstName} {request.Buyer.LastName.Substring(0, 1)}."
                                    : request.Buyer.FirstName;
                                var rowClass = request.ResolutionSLABreached || request.FirstResponseSLABreached 
                                    ? "table-danger" 
                                    : (request.Status == MercatoApp.Models.ReturnStatus.UnderAdminReview ? "table-warning" : "");

                                <tr class="@rowClass">
                                    <td>
                                        <strong>@request.ReturnNumber</strong>
                                        @if (request.EscalationReason != MercatoApp.Models.EscalationReason.None)
                                        {
                                            <br/><small class="text-danger"><i class="bi bi-flag-fill"></i> Escalated</small>
                                        }
                                    </td>
                                    <td>
                                        <i class="bi bi-@requestIcon"></i> @requestTypeLabel
                                    </td>
                                    <td>
                                        @request.SubOrder.Store.StoreName
                                        <br/><small class="text-muted">@request.SubOrder.Store.Id</small>
                                    </td>
                                    <td>
                                        @buyerAlias
                                        <br/><small class="text-muted">@request.Buyer.Email</small>
                                    </td>
                                    <td>
                                        @await Html.PartialAsync("_ReturnStatusBadge", request.Status)
                                    </td>
                                    <td>
                                        @if (request.ResolutionSLABreached)
                                        {
                                            <span class="badge bg-danger" title="Resolution deadline: @request.ResolutionDeadline?.ToString("MMM dd, HH:mm")">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Resolution Breach
                                            </span>
                                        }
                                        else if (request.FirstResponseSLABreached)
                                        {
                                            <span class="badge bg-warning text-dark" title="First response deadline: @request.FirstResponseDeadline?.ToString("MMM dd, HH:mm")">
                                                <i class="bi bi-exclamation-circle-fill"></i> Response Breach
                                            </span>
                                        }
                                        else if (request.ResolutionDeadline.HasValue)
                                        {
                                            var hoursUntilDeadline = (request.ResolutionDeadline.Value - DateTime.UtcNow).TotalHours;
                                            if (hoursUntilDeadline < 4)
                                            {
                                                <span class="badge bg-warning text-dark" title="Resolution deadline: @request.ResolutionDeadline?.ToString("MMM dd, HH:mm")">
                                                    <i class="bi bi-clock"></i> @Math.Round(hoursUntilDeadline, 1)h left
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success" title="Resolution deadline: @request.ResolutionDeadline?.ToString("MMM dd, HH:mm")">
                                                    <i class="bi bi-check-circle"></i> On Track
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (caseAge == 0)
                                        {
                                            <span class="badge bg-light text-dark">Today</span>
                                        }
                                        else if (caseAge == 1)
                                        {
                                            <span class="badge bg-light text-dark">1 day</span>
                                        }
                                        else if (caseAge > 7)
                                        {
                                            <span class="badge bg-danger">@caseAge days</span>
                                        }
                                        else if (caseAge > 3)
                                        {
                                            <span class="badge bg-warning text-dark">@caseAge days</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-dark">@caseAge days</span>
                                        }
                                    </td>
                                    <td>
                                        @request.RefundAmount.ToString("C")
                                    </td>
                                    <td>
                                        @if (messageCount > 0)
                                        {
                                            <span class="badge bg-info">@messageCount</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-page="/Admin/Returns/Detail" asp-route-id="@request.Id" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>
