@page
@model MercatoApp.Pages.Account.OrdersModel
@{
    ViewData["Title"] = "My Orders";
}

<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <h1 class="mb-4">
                <i class="bi bi-bag-check"></i> My Orders
            </h1>

            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel"></i> Filter Orders
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <!-- Status Filter -->
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select name="SelectedStatuses" class="form-select" multiple size="7">
                                @{
                                    var isNewSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.New) == true;
                                    var isPaidSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Paid) == true;
                                    var isPreparingSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Preparing) == true;
                                    var isShippedSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Shipped) == true;
                                    var isDeliveredSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Delivered) == true;
                                    var isCancelledSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Cancelled) == true;
                                    var isRefundedSelected = Model.SelectedStatuses?.Contains(MercatoApp.Models.OrderStatus.Refunded) == true;
                                }
                                <option value="@((int)MercatoApp.Models.OrderStatus.New)" selected="@isNewSelected">New</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Paid)" selected="@isPaidSelected">Paid</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Preparing)" selected="@isPreparingSelected">Preparing</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Shipped)" selected="@isShippedSelected">Shipped</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Delivered)" selected="@isDeliveredSelected">Delivered</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Cancelled)" selected="@isCancelledSelected">Cancelled</option>
                                <option value="@((int)MercatoApp.Models.OrderStatus.Refunded)" selected="@isRefundedSelected">Refunded</option>
                            </select>
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                        </div>

                        <!-- Date Range & Seller Filter -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="FromDate" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="FromDate" name="FromDate" 
                                    value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="mb-3">
                                <label for="ToDate" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="ToDate" name="ToDate" 
                                    value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
                            </div>
                            @if (Model.AvailableSellers.Any())
                            {
                                <div class="mb-3">
                                    <label for="SellerId" class="form-label">Seller</label>
                                    <select class="form-select" id="SellerId" name="SellerId">
                                        <option value="">All Sellers</option>
                                        @foreach (var seller in Model.AvailableSellers)
                                        {
                                            var isSellerSelected = Model.SellerId == seller.Id;
                                            <option value="@seller.Id" selected="@isSellerSelected">
                                                @seller.StoreName
                                            </option>
                                        }
                                    </select>
                                </div>
                            }
                        </div>

                        <!-- Filter Actions -->
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Apply Filters
                            </button>
                            <a asp-page="/Account/Orders" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Info -->
            @if (Model.TotalCount > 0)
            {
                <div class="alert alert-info">
                    Showing @Model.Orders.Count of @Model.TotalCount order(s)
                    @if (Model.CurrentPage > 1)
                    {
                        <span> - Page @Model.CurrentPage of @Model.TotalPages</span>
                    }
                </div>
            }

            <!-- Order List -->
            @if (!Model.Orders.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    @if (Model.SelectedStatuses != null || Model.FromDate != null || Model.ToDate != null || Model.SellerId != null)
                    {
                        <text>No orders found matching your filters. Try adjusting your search criteria.</text>
                    }
                    else
                    {
                        <text>You haven't placed any orders yet. <a asp-page="/Index" class="alert-link">Start shopping</a></text>
                    }
                </div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var order in Model.Orders)
                    {
                        <div class="list-group-item mb-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-2">
                                        <a asp-page="/Account/OrderDetail" asp-route-orderId="@order.Id" class="text-decoration-none">
                                            Order #@order.OrderNumber
                                        </a>
                                    </h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar"></i> Placed on @order.OrderedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                    </p>
                                    <p class="mb-2">
                                        <strong>Status:</strong>
                                        @if (order.Status == MercatoApp.Models.OrderStatus.New)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-hourglass-split"></i> New
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Paid)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Paid
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Preparing)
                                        {
                                            <span class="badge bg-info">
                                                <i class="bi bi-box-seam"></i> Preparing
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Shipped)
                                        {
                                            <span class="badge bg-primary">
                                                <i class="bi bi-truck"></i> Shipped
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Delivered)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Delivered
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Cancelled)
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-x-circle"></i> Cancelled
                                            </span>
                                        }
                                        else if (order.Status == MercatoApp.Models.OrderStatus.Refunded)
                                        {
                                            <span class="badge bg-dark">
                                                <i class="bi bi-arrow-counterclockwise"></i> Refunded
                                            </span>
                                        }
                                    </p>
                                    <p class="mb-0">
                                        <strong>Payment:</strong>
                                        <partial name="_PaymentStatusBadge" model="order.PaymentStatus" />
                                        @if (order.PaymentStatus == MercatoApp.Models.PaymentStatus.Refunded && order.RefundedAmount > 0)
                                        {
                                            <br/>
                                            <small class="text-muted">Refunded: @order.RefundedAmount.ToString("C")</small>
                                        }
                                    </p>
                                    @if (order.SubOrders.Any())
                                    {
                                        <p class="mb-0 mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-shop"></i> 
                                                Sellers: @string.Join(", ", order.SubOrders.Select(so => so.Store.StoreName).Distinct())
                                            </small>
                                        </p>
                                    }
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <p class="h4 text-primary mb-2">@order.TotalAmount.ToString("C")</p>
                                    <a asp-page="/Account/OrderDetail" asp-route-orderId="@order.Id" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                            
                            @if (order.DeliveryAddress != null)
                            {
                                <hr class="my-2" />
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-geo-alt"></i> 
                                    Delivering to: @order.DeliveryAddress.AddressLine1, @order.DeliveryAddress.City, @order.DeliveryAddress.CountryCode
                                </p>
                            }
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Order list pagination">
                        <ul class="pagination justify-content-center">
                            <!-- Previous Page -->
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" 
                                   asp-page="/Account/Orders" 
                                   asp-route-pageNumber="@(Model.CurrentPage - 1)"
                                   asp-route-selectedStatuses="@string.Join(",", Model.SelectedStatuses?.Select(s => (int)s) ?? Array.Empty<int>())"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                   asp-route-sellerId="@Model.SellerId">
                                    Previous
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            @{
                                var startPage = Math.Max(1, Model.CurrentPage - 2);
                                var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" 
                                       asp-page="/Account/Orders" 
                                       asp-route-pageNumber="1"
                                       asp-route-selectedStatuses="@string.Join(",", Model.SelectedStatuses?.Select(s => (int)s) ?? Array.Empty<int>())"
                                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                       asp-route-sellerId="@Model.SellerId">
                                        1
                                    </a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                            }

                            @for (var i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" 
                                       asp-page="/Account/Orders" 
                                       asp-route-pageNumber="@i"
                                       asp-route-selectedStatuses="@string.Join(",", Model.SelectedStatuses?.Select(s => (int)s) ?? Array.Empty<int>())"
                                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                       asp-route-sellerId="@Model.SellerId">
                                        @i
                                    </a>
                                </li>
                            }

                            @if (endPage < Model.TotalPages)
                            {
                                @if (endPage < Model.TotalPages - 1)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                                <li class="page-item">
                                    <a class="page-link" 
                                       asp-page="/Account/Orders" 
                                       asp-route-pageNumber="@Model.TotalPages"
                                       asp-route-selectedStatuses="@string.Join(",", Model.SelectedStatuses?.Select(s => (int)s) ?? Array.Empty<int>())"
                                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                       asp-route-sellerId="@Model.SellerId">
                                        @Model.TotalPages
                                    </a>
                                </li>
                            }

                            <!-- Next Page -->
                            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" 
                                   asp-page="/Account/Orders" 
                                   asp-route-pageNumber="@(Model.CurrentPage + 1)"
                                   asp-route-selectedStatuses="@string.Join(",", Model.SelectedStatuses?.Select(s => (int)s) ?? Array.Empty<int>())"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                   asp-route-sellerId="@Model.SellerId">
                                    Next
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </div>
    </div>
</div>
