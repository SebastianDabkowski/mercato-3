@page "/product/{id:int}"
@model MercatoApp.Pages.ProductModel
@using MercatoApp.Helpers
@{
    ViewData["Title"] = Model.Product?.Title ?? "Product";
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Product != null && Model.IsProductAvailable)
{
    var imageList = Model.Product.ImageUrls.ParseCommaSeparated();
    
    <!-- Back to Results Button -->
    @if (Model.HasReferrer)
    {
        <div class="mb-3">
            <a href="@Model.ReferrerUrl" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to Results
            </a>
        </div>
    }
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Product Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h1 class="mb-0">@Model.Product.Title</h1>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            @if (imageList.Count > 0)
                            {
                                <div class="mb-3">
                                    <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-inner">
                                            @for (var i = 0; i < imageList.Count; i++)
                                            {
                                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                                    <img src="@imageList[i]" class="d-block w-100 rounded" alt="@Model.Product.Title image @(i + 1)" style="max-height: 300px; object-fit: contain;" />
                                                </div>
                                            }
                                        </div>
                                        @if (imageList.Count > 1)
                                        {
                                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(Model.Product.Description))
                            {
                                <p class="lead">@Model.Product.Description</p>
                            }
                            
                            <dl class="row">
                                <dt class="col-sm-3">Category</dt>
                                <dd class="col-sm-9">
                                    @if (Model.Product.CategoryId.HasValue && Model.Product.CategoryEntity != null)
                                    {
                                        <a asp-page="/Category" asp-route-id="@Model.Product.CategoryId.Value" class="badge bg-secondary text-decoration-none">
                                            @Model.Product.Category
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@Model.Product.Category</span>
                                    }
                                </dd>
                                
                                @if (!Model.Product.HasVariants)
                                {
                                    <dt class="col-sm-3">Availability</dt>
                                    <dd class="col-sm-9">
                                        @if (Model.Product.Stock > 0)
                                        {
                                            <span class="text-success">@Model.Product.Stock in stock</span>
                                        }
                                        else
                                        {
                                            <span class="text-danger">Out of stock</span>
                                        }
                                    </dd>
                                }
                            </dl>

                            @if (Model.Product.HasVariants && Model.VariantAttributes.Count > 0)
                            {
                                <div class="border-top pt-3 mt-3">
                                    <h5 class="mb-3">Select Options</h5>
                                    <form method="get" id="variantSelectionForm">
                                        <input type="hidden" name="id" value="@Model.Product.Id" />
                                        @foreach (var attr in Model.VariantAttributes)
                                        {
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">@attr.Name</label>
                                                <div class="btn-group-vertical d-md-flex flex-md-wrap gap-2" role="group">
                                                    @foreach (var value in attr.Values)
                                                    {
                                                        <button type="button" class="btn btn-outline-primary variant-option-btn" 
                                                                data-attribute="@attr.Name" 
                                                                data-value="@value.Value">
                                                            @value.Value
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        <input type="hidden" name="variantId" id="selectedVariantId" />
                                    </form>
                                    
                                    <div id="variantInfo" class="alert alert-info mt-3" style="display: none;">
                                        <div id="variantStock"></div>
                                        <div id="variantPrice"></div>
                                    </div>
                                    
                                    <div id="variantWarning" class="alert alert-warning mt-3" style="display: none;">
                                        Please select all options to view availability.
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="col-md-4 text-center text-md-end">
                            <div class="mb-3">
                                @if (Model.Product.HasVariants && Model.SelectedVariant != null)
                                {
                                    var variantPrice = Model.SelectedVariant.PriceOverride ?? Model.Product.Price;
                                    <span class="h2 text-primary">@variantPrice.ToString("C")</span>
                                }
                                else if (!Model.Product.HasVariants)
                                {
                                    <span class="h2 text-primary">@Model.Product.Price.ToString("C")</span>
                                }
                                else
                                {
                                    <span class="h2 text-muted">Select options</span>
                                }
                            </div>
                            
                            @{
                                var hasStock = false;
                                if (Model.Product.HasVariants && Model.SelectedVariant != null)
                                {
                                    hasStock = Model.SelectedVariant.Stock > 0 && Model.SelectedVariant.IsEnabled;
                                }
                                else if (!Model.Product.HasVariants)
                                {
                                    hasStock = Model.Product.Stock > 0;
                                }
                            }
                            
                            @if (hasStock)
                            {
                                <form method="post" asp-page-handler="AddToCart">
                                    <input type="hidden" name="id" value="@Model.Product.Id" />
                                    <input type="hidden" name="variantId" value="@Model.SelectedVariant?.Id" />
                                    <input type="hidden" name="quantity" value="1" />
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-cart-plus"></i> Add to Cart
                                    </button>
                                </form>
                            }
                            else if (Model.Product.HasVariants && Model.SelectedVariant == null)
                            {
                                <button type="button" class="btn btn-secondary btn-lg" disabled>
                                    Select Options
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-secondary btn-lg" disabled aria-label="Out of Stock - Product currently unavailable">
                                    Out of Stock
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shipping Information -->
            @if (Model.Product.Weight.HasValue || Model.Product.Length.HasValue || Model.Product.Width.HasValue || Model.Product.Height.HasValue || !string.IsNullOrEmpty(Model.Product.ShippingMethods))
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Shipping Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            @if (Model.Product.Weight.HasValue)
                            {
                                <dt class="col-sm-3">Weight</dt>
                                <dd class="col-sm-9">@Model.Product.Weight.Value kg</dd>
                            }
                            @if (Model.Product.Length.HasValue && Model.Product.Width.HasValue && Model.Product.Height.HasValue)
                            {
                                <dt class="col-sm-3">Dimensions</dt>
                                <dd class="col-sm-9">
                                    @Model.Product.Length.Value x @Model.Product.Width.Value x @Model.Product.Height.Value cm
                                </dd>
                            }
                            else if (Model.Product.Length.HasValue || Model.Product.Width.HasValue || Model.Product.Height.HasValue)
                            {
                                <dt class="col-sm-3">Dimensions</dt>
                                <dd class="col-sm-9">
                                    @if (Model.Product.Length.HasValue) { <span>L: @Model.Product.Length.Value cm</span> }
                                    @if (Model.Product.Width.HasValue) { <span>W: @Model.Product.Width.Value cm</span> }
                                    @if (Model.Product.Height.HasValue) { <span>H: @Model.Product.Height.Value cm</span> }
                                </dd>
                            }
                            @{
                                var shippingMethods = Model.Product.ShippingMethods.ParseCommaSeparated();
                            }
                            @if (shippingMethods.Count > 0)
                            {
                                <dt class="col-sm-3">Shipping Options</dt>
                                <dd class="col-sm-9">
                                    @foreach (var method in shippingMethods)
                                    {
                                        <span class="badge bg-info me-1">@method</span>
                                    }
                                </dd>
                            }
                        </dl>
                    </div>
                </div>
            }
            
            <!-- Store Information -->
            @if (Model.Product.Store != null)
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Sold by</h5>
                    </div>
                    <div class="card-body">
                        <a asp-page="/Store" asp-route-slug="@Model.Product.Store.Slug" class="text-decoration-none">
                            <strong>@Model.Product.Store.StoreName</strong>
                        </a>
                        @if (!string.IsNullOrEmpty(Model.Product.Store.Category))
                        {
                            <span class="ms-2 badge bg-light text-dark">@Model.Product.Store.Category</span>
                        }
                    </div>
                </div>
            }
        </div>
        
        <div class="col-lg-4">
            <!-- Product Info Sidebar -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Product Info</h5>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt>Listed</dt>
                        <dd>@Model.Product.CreatedAt.ToString("MMMM d, yyyy")</dd>
                        
                        <dt>Last Updated</dt>
                        <dd>@Model.Product.UpdatedAt.ToString("MMMM d, yyyy")</dd>
                    </dl>
                </div>
            </div>
            
            <!-- Recently Viewed Products -->
            @await Component.InvokeAsync("RecentlyViewed", new { maxItems = 5, currentProductId = Model.Product.Id })
        </div>
    </div>
}
else if (Model.Product != null && !Model.IsProductAvailable)
{
    <div class="text-center py-5">
        <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-box-seam text-muted" viewBox="0 0 16 16">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
        </div>
        <h2>Product Unavailable</h2>
        <p class="text-muted">@Model.UnavailableMessage</p>
        <a asp-page="/Index" class="btn btn-primary">Go to Home</a>
    </div>
}
else
{
    <div class="text-center py-5">
        <h2>Product Not Found</h2>
        <p class="text-muted">The product you're looking for doesn't exist or is no longer available.</p>
        <a asp-page="/Index" class="btn btn-primary">Go to Home</a>
    </div>
}

@section Scripts {
    @if (Model.Product?.HasVariants == true)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const variants = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Variants.Select(v => new {
                    id = v.Id,
                    stock = v.Stock,
                    price = v.PriceOverride ?? Model.Product.Price,
                    isEnabled = v.IsEnabled,
                    options = v.Options.Select(o => new { 
                        attribute = o.AttributeValue.VariantAttribute.Name,
                        value = o.AttributeValue.Value 
                    }).ToList()
                }).ToList()));

                const selectedOptions = {};
                const variantButtons = document.querySelectorAll('.variant-option-btn');
                const variantInfo = document.getElementById('variantInfo');
                const variantWarning = document.getElementById('variantWarning');
                const variantStock = document.getElementById('variantStock');
                const variantPrice = document.getElementById('variantPrice');
                const selectedVariantId = document.getElementById('selectedVariantId');

                variantButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const attribute = this.getAttribute('data-attribute');
                        const value = this.getAttribute('data-value');

                        // Update selected options
                        selectedOptions[attribute] = value;

                        // Update button states for this attribute
                        document.querySelectorAll(`[data-attribute="${attribute}"]`).forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');

                        // Find matching variant
                        const matchingVariant = findMatchingVariant();
                        
                        if (matchingVariant) {
                            // Update variant info
                            variantInfo.style.display = 'block';
                            variantWarning.style.display = 'none';
                            
                            if (matchingVariant.isEnabled && matchingVariant.stock > 0) {
                                variantStock.innerHTML = `<i class="bi bi-check-circle text-success"></i> <strong>${matchingVariant.stock}</strong> in stock`;
                            } else if (!matchingVariant.isEnabled) {
                                variantStock.innerHTML = '<i class="bi bi-x-circle text-danger"></i> This variant is not available';
                            } else {
                                variantStock.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Out of stock';
                            }
                            
                            variantPrice.innerHTML = `<strong>Price:</strong> ${formatCurrency(matchingVariant.price)}`;
                            selectedVariantId.value = matchingVariant.id;
                            
                            // Reload page with selected variant
                            window.location.href = `?id=${@Model.Product.Id}&variantId=${matchingVariant.id}`;
                        } else {
                            // Check if all options are selected
                            const allOptionsSelected = Object.keys(selectedOptions).length === @Model.VariantAttributes.Count;
                            
                            if (allOptionsSelected) {
                                variantInfo.style.display = 'block';
                                variantWarning.style.display = 'none';
                                variantStock.innerHTML = '<i class="bi bi-x-circle text-danger"></i> This combination is not available';
                                variantPrice.innerHTML = '';
                                selectedVariantId.value = '';
                            } else {
                                variantInfo.style.display = 'none';
                                variantWarning.style.display = 'block';
                            }
                        }
                    });
                });

                function findMatchingVariant() {
                    return variants.find(variant => {
                        return variant.options.every(option => {
                            return selectedOptions[option.attribute] === option.value;
                        });
                    });
                }

                function formatCurrency(value) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(value);
                }

                // Pre-select variant if one is already selected
                @if (Model.SelectedVariant != null)
                {
                    <text>
                    @foreach (var option in Model.SelectedVariant.Options)
                    {
                        <text>
                        selectedOptions['@option.AttributeValue.VariantAttribute.Name'] = '@option.AttributeValue.Value';
                        document.querySelector(`[data-attribute="@option.AttributeValue.VariantAttribute.Name"][data-value="@option.AttributeValue.Value"]`)?.classList.add('active');
                        </text>
                    }
                    
                    variantInfo.style.display = 'block';
                    variantWarning.style.display = 'none';
                    
                    @if (Model.SelectedVariant.IsEnabled && Model.SelectedVariant.Stock > 0)
                    {
                        <text>
                        variantStock.innerHTML = '<i class="bi bi-check-circle text-success"></i> <strong>@Model.SelectedVariant.Stock</strong> in stock';
                        </text>
                    }
                    else if (!Model.SelectedVariant.IsEnabled)
                    {
                        <text>
                        variantStock.innerHTML = '<i class="bi bi-x-circle text-danger"></i> This variant is not available';
                        </text>
                    }
                    else
                    {
                        <text>
                        variantStock.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Out of stock';
                        </text>
                    }
                    
                    variantPrice.innerHTML = '<strong>Price:</strong> @((Model.SelectedVariant.PriceOverride ?? Model.Product.Price).ToString("C"))';
                    selectedVariantId.value = '@Model.SelectedVariant.Id';
                    </text>
                }
            });
        </script>
    }
}

