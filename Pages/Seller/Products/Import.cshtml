@page
@model MercatoApp.Pages.Seller.Products.ImportModel
@{
    ViewData["Title"] = "Import Products";
}

<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="mb-4">
            <h1>Import Products</h1>
            <p class="text-muted">Upload a CSV or Excel file to import your product catalog.</p>
        </div>

        @if (Model.ErrorMessages.Count > 0)
        {
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading">Upload Failed</h5>
                <ul class="mb-0">
                    @foreach (var error in Model.ErrorMessages)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
        }

        @if (Model.ValidationResult != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Import Preview</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Summary</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total Rows:</strong> @Model.ValidationResult.TotalRows</li>
                                <li><strong>New Products:</strong> <span class="text-success">@Model.ValidationResult.NewProducts</span></li>
                                <li><strong>Existing Products (Updates):</strong> <span class="text-info">@Model.ValidationResult.ExistingProducts</span></li>
                                <li><strong>Validation Errors:</strong> <span class="text-danger">@Model.ValidationResult.ValidationResults.Count(r => !r.Success)</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>File Information</h6>
                            <ul class="list-unstyled">
                                <li><strong>File Name:</strong> @Model.FileName</li>
                                <li><strong>File Type:</strong> @Model.FileType</li>
                            </ul>
                        </div>
                    </div>

                    @if (Model.ValidationResult.ValidationResults.Any(r => !r.Success))
                    {
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">Validation Errors Found</h6>
                            <p class="mb-0">The following rows have validation errors and will not be imported. Please fix these errors in your file and try again.</p>
                        </div>

                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Row</th>
                                        <th>SKU</th>
                                        <th>Title</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in Model.ValidationResult.ValidationResults.Where(r => !r.Success))
                                    {
                                        <tr>
                                            <td>@result.RowNumber</td>
                                            <td>@(result.Sku ?? "-")</td>
                                            <td>@(result.Title ?? "-")</td>
                                            <td class="text-danger">@result.ErrorMessage</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    @if (Model.ValidationResult.Success)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> All rows passed validation and are ready to import.
                        </div>

                        <form method="post" asp-page-handler="Confirm">
                            <input type="hidden" asp-for="JobId" />
                            <div class="d-flex justify-content-between">
                                <a asp-page="Index" class="btn btn-outline-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Confirm and Import
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="mt-3">
                            <a asp-page="Import" class="btn btn-outline-secondary">Upload Different File</a>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Upload File</h5>
                    <p class="card-text">Select a CSV or Excel (.xlsx, .xls) file containing your product data.</p>

                    <form method="post" enctype="multipart/form-data" asp-page-handler="Upload">
                        <div class="mb-3">
                            <label asp-for="UploadedFile" class="form-label">Product File</label>
                            <input asp-for="UploadedFile" class="form-control" type="file" accept=".csv,.xlsx,.xls" required />
                            <div class="form-text">
                                Supported formats: CSV, Excel (.xlsx, .xls). Maximum file size: 10 MB.
                            </div>
                            <span asp-validation-for="UploadedFile" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-page="Index" class="btn btn-outline-secondary">
                                ‚Üê Back to Products
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-file-earmark-arrow-up"></i> Upload and Validate
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">File Format</h5>
                </div>
                <div class="card-body">
                    <p>Your import file must include the following columns:</p>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Column Name</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                    <th>Example</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>SKU</code></td>
                                    <td>Optional</td>
                                    <td>Stock Keeping Unit (used for updates)</td>
                                    <td>PROD-001</td>
                                </tr>
                                <tr>
                                    <td><code>Title</code></td>
                                    <td><span class="badge bg-danger">Required</span></td>
                                    <td>Product title (max 200 characters)</td>
                                    <td>Blue Cotton T-Shirt</td>
                                </tr>
                                <tr>
                                    <td><code>Description</code></td>
                                    <td>Optional</td>
                                    <td>Product description (max 2000 characters)</td>
                                    <td>Comfortable cotton t-shirt...</td>
                                </tr>
                                <tr>
                                    <td><code>Price</code></td>
                                    <td><span class="badge bg-danger">Required</span></td>
                                    <td>Product price (decimal number)</td>
                                    <td>19.99</td>
                                </tr>
                                <tr>
                                    <td><code>Stock</code></td>
                                    <td><span class="badge bg-danger">Required</span></td>
                                    <td>Stock quantity (integer)</td>
                                    <td>100</td>
                                </tr>
                                <tr>
                                    <td><code>Category</code></td>
                                    <td>Optional</td>
                                    <td>Product category (max 100 characters)</td>
                                    <td>Clothing</td>
                                </tr>
                                <tr>
                                    <td><code>Weight</code></td>
                                    <td>Optional</td>
                                    <td>Weight in kilograms (decimal)</td>
                                    <td>0.25</td>
                                </tr>
                                <tr>
                                    <td><code>Length</code></td>
                                    <td>Optional</td>
                                    <td>Length in centimeters (decimal)</td>
                                    <td>30</td>
                                </tr>
                                <tr>
                                    <td><code>Width</code></td>
                                    <td>Optional</td>
                                    <td>Width in centimeters (decimal)</td>
                                    <td>20</td>
                                </tr>
                                <tr>
                                    <td><code>Height</code></td>
                                    <td>Optional</td>
                                    <td>Height in centimeters (decimal)</td>
                                    <td>5</td>
                                </tr>
                                <tr>
                                    <td><code>ShippingMethods</code></td>
                                    <td>Optional</td>
                                    <td>Comma-separated shipping methods</td>
                                    <td>Standard,Express</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p class="mb-0 mt-3">
                        <strong>Note:</strong> If a SKU is provided and matches an existing product, that product will be updated. Otherwise, a new product will be created.
                    </p>
                </div>
            </div>
        }

        <div class="mt-3">
            <a asp-page="ImportHistory" class="btn btn-outline-primary">
                <i class="bi bi-clock-history"></i> View Import History
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
