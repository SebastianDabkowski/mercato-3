@page "{subOrderId:int}"
@model MercatoApp.Pages.Seller.Refunds.RequestRefundModel
@{
    ViewData["Title"] = "Request Refund";
}

<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-page="/Seller/Orders">Orders</a></li>
                    @if (Model.SubOrder != null)
                    {
                        <li class="breadcrumb-item">
                            <a asp-page="/Seller/OrderDetails" asp-route-id="@Model.SubOrder.Id">
                                @Model.SubOrder.SubOrderNumber
                            </a>
                        </li>
                    }
                    <li class="breadcrumb-item active" aria-current="page">Request Refund</li>
                </ol>
            </nav>
            <h1 class="mb-3">
                <i class="bi bi-arrow-return-left"></i> Request Refund
            </h1>
        </div>
    </div>

    @if (Model.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.SubOrder == null)
    {
        <div class="alert alert-danger">
            Sub-order not found or you don't have permission to access it.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sub-Order Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Sub-Order Number:</strong></p>
                                <p>@Model.SubOrder.SubOrderNumber</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Status:</strong></p>
                                <p>
                                    @switch (Model.SubOrder.Status)
                                    {
                                        case MercatoApp.Models.OrderStatus.Paid:
                                            <span class="badge bg-success">Paid</span>
                                            break;
                                        case MercatoApp.Models.OrderStatus.Preparing:
                                            <span class="badge bg-info">Preparing</span>
                                            break;
                                        case MercatoApp.Models.OrderStatus.Shipped:
                                            <span class="badge bg-primary">Shipped</span>
                                            break;
                                        case MercatoApp.Models.OrderStatus.Delivered:
                                            <span class="badge bg-success">Delivered</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@Model.SubOrder.Status</span>
                                            break;
                                    }
                                </p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Total Amount:</strong></p>
                                <p class="h5">@Model.SubOrder.TotalAmount.ToString("C")</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Refunded Amount:</strong></p>
                                <p class="h5">@Model.SubOrder.RefundedAmount.ToString("C")</p>
                            </div>
                        </div>

                        <div class="mb-3">
                            <p class="mb-1"><strong>Available to Refund:</strong></p>
                            <p class="h5 text-success">@((Model.SubOrder.TotalAmount - Model.SubOrder.RefundedAmount).ToString("C"))</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Refund Request</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <input type="hidden" asp-for="SubOrderId" />
                            
                            <div class="mb-3">
                                <label asp-for="RefundAmount" class="form-label">Refund Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="RefundAmount" class="form-control" type="number" step="0.01" min="0.01" 
                                           placeholder="0.00" max="@(Model.SubOrder.TotalAmount - Model.SubOrder.RefundedAmount)" />
                                </div>
                                <span asp-validation-for="RefundAmount" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    Maximum refundable: @((Model.SubOrder.TotalAmount - Model.SubOrder.RefundedAmount).ToString("C"))
                                </small>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Reason" class="form-label">Reason for Refund</label>
                                <textarea asp-for="Reason" class="form-control" rows="4" 
                                          placeholder="Please provide a detailed reason for the refund request"></textarea>
                                <span asp-validation-for="Reason" class="text-danger"></span>
                            </div>

                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Important:</strong> Refund requests are subject to admin approval. 
                                Once approved, the funds will be returned to the buyer and your escrow balance will be adjusted accordingly.
                            </div>

                            <div class="d-flex justify-content-between">
                                <a asp-page="/Seller/OrderDetails" asp-route-id="@Model.SubOrder.Id" 
                                   class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                                <button type="submit" class="btn btn-primary" 
                                        onclick="return confirm('Are you sure you want to request this refund?');">
                                    <i class="bi bi-arrow-return-left"></i> Request Refund
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Refund Policy</h6>
                    </div>
                    <div class="card-body">
                        <h6>Seller Refund Guidelines</h6>
                        <ul class="small">
                            <li>Refunds can be requested for orders in Paid, Preparing, or Shipped status</li>
                            <li>Cannot refund orders that have been delivered</li>
                            <li>Cannot refund if escrow has been released</li>
                            <li>Partial refunds are supported</li>
                            <li>All refunds require admin approval</li>
                        </ul>

                        <h6 class="mt-3">What Happens Next?</h6>
                        <ul class="small">
                            <li>Your refund request will be sent to admin for review</li>
                            <li>Admin may approve or reject the request</li>
                            <li>If approved, funds return to buyer automatically</li>
                            <li>Your escrow balance will be adjusted proportionally</li>
                            <li>Commission will be recalculated</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
