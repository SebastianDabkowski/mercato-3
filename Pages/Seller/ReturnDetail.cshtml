@page
@model MercatoApp.Pages.Seller.ReturnDetailModel
@{
    ViewData["Title"] = $"Return Case {Model.ReturnRequest?.ReturnNumber} - Seller Panel";
}

<div class="container-fluid my-4">
    @if (Model.ReturnRequest == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill"></i> Return request not found.
        </div>
        <a asp-page="/Seller/Returns" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Returns
        </a>
    }
    else
    {
        var requestTypeLabel = Model.ReturnRequest.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "Complaint" : "Return";
        var requestIcon = Model.ReturnRequest.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "exclamation-triangle" : "arrow-return-left";
        var requestTypeClass = Model.ReturnRequest.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "text-danger" : "text-primary";

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-page="/Seller/Returns">Returns & Complaints</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@Model.ReturnRequest.ReturnNumber</li>
                    </ol>
                </nav>
                <h1 class="mb-3">
                    <i class="bi bi-@requestIcon @requestTypeClass"></i> @requestTypeLabel Case: @Model.ReturnRequest.ReturnNumber
                </h1>
            </div>
            <div class="col-auto">
                @await Html.PartialAsync("_ReturnStatusBadge", Model.ReturnRequest.Status)
            </div>
        </div>

        <!-- Success/Error Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Case Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i> Case Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Buyer:</strong><br />
                                @Model.ReturnRequest.Buyer.FirstName @Model.ReturnRequest.Buyer.LastName<br />
                                <small class="text-muted">@Model.ReturnRequest.Buyer.Email</small>
                            </div>
                            <div class="col-md-6">
                                <strong>Order Reference:</strong><br />
                                <a asp-page="/Seller/OrderDetails" asp-route-id="@Model.ReturnRequest.SubOrder.Id">
                                    @Model.ReturnRequest.SubOrder.SubOrderNumber
                                </a>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Request Type:</strong><br />
                                <span class="@requestTypeClass">
                                    <i class="bi bi-@requestIcon"></i> @requestTypeLabel
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>Reason:</strong><br />
                                @Model.ReturnRequest.Reason.ToString()
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Created:</strong><br />
                                @Model.ReturnRequest.RequestedAt.ToString("MMM dd, yyyy HH:mm")
                            </div>
                            <div class="col-md-6">
                                <strong>Last Updated:</strong><br />
                                @Model.ReturnRequest.UpdatedAt.ToString("MMM dd, yyyy HH:mm")
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Model.ReturnRequest.Description))
                        {
                            <div class="row">
                                <div class="col-12">
                                    <strong>Buyer Description:</strong><br />
                                    <p class="mt-2 p-3 bg-light border rounded">@Model.ReturnRequest.Description</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Items Being Returned -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box-seam"></i> Items @(Model.ReturnRequest.IsFullReturn ? "(Full Return)" : "(Partial Return)")
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.ReturnRequest.IsFullReturn)
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.ReturnRequest.SubOrder.Items)
                                        {
                                            <tr>
                                                <td>@item.ProductTitle</td>
                                                <td>@item.Quantity</td>
                                                <td>@item.UnitPrice.ToString("C")</td>
                                                <td>@((item.UnitPrice * item.Quantity).ToString("C"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Quantity</th>
                                            <th>Refund Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.ReturnRequest.Items)
                                        {
                                            <tr>
                                                <td>@item.OrderItem.ProductTitle</td>
                                                <td>@item.Quantity</td>
                                                <td>@item.RefundAmount.ToString("C")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        <div class="mt-3">
                            <strong>Total Refund Amount: @Model.ReturnRequest.RefundAmount.ToString("C")</strong>
                        </div>
                    </div>
                </div>

                <!-- Seller Notes/Response -->
                @if (Model.ReturnRequest.Status != MercatoApp.Models.ReturnStatus.Requested && !string.IsNullOrWhiteSpace(Model.ReturnRequest.SellerNotes))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-chat-left-text"></i> Your Response
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">@Model.ReturnRequest.SellerNotes</p>
                        </div>
                    </div>
                }

                <!-- Messaging Thread -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots"></i> Conversation with Buyer
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.ReturnRequest.Messages.Any())
                        {
                            <div class="list-group mb-3" style="max-height: 400px; overflow-y: auto;">
                                @foreach (var message in Model.ReturnRequest.Messages.OrderBy(m => m.SentAt))
                                {
                                    <div class="list-group-item @(message.IsFromSeller ? "border-start border-primary border-3" : "border-start border-success border-3")">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong>
                                                    @if (message.IsFromSeller)
                                                    {
                                                        <i class="bi bi-shop"></i> @("You")
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-person"></i> @("Buyer")
                                                    }
                                                </strong>
                                            </div>
                                            <small class="text-muted">
                                                @message.SentAt.ToString("MMM dd, yyyy 'at' h:mm tt")
                                            </small>
                                        </div>
                                        <p class="mb-0">@message.Content</p>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> 
                                No messages yet. You can send a message to the buyer below.
                            </div>
                        }

                        <!-- Message Submission Form -->
                        <div class="border-top pt-3">
                            <form method="post" asp-page-handler="AddMessage" asp-route-returnRequestId="@Model.ReturnRequest.Id">
                                <div class="mb-3">
                                    <label for="newMessage" class="form-label fw-bold">
                                        <i class="bi bi-chat-left-text"></i> Send a Message
                                    </label>
                                    <textarea 
                                        class="form-control" 
                                        id="newMessage" 
                                        asp-for="NewMessageContent"
                                        rows="3" 
                                        maxlength="2000" 
                                        required
                                        placeholder="Type your message here (max 2000 characters)..."
                                        aria-describedby="messageHelp"></textarea>
                                    <small id="messageHelp" class="form-text text-muted">
                                        Please do not share personal contact information like email addresses or phone numbers.
                                    </small>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send"></i> Send Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Resolution Display (if already resolved) -->
                @if (Model.ReturnRequest.Status == MercatoApp.Models.ReturnStatus.Resolved)
                {
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-check-circle"></i> Case Resolved
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Resolution:</strong><br />
                                @Model.ReturnRequest.ResolutionType.ToString()
                            </p>
                            @if (Model.ReturnRequest.ResolutionAmount.HasValue)
                            {
                                <p class="mb-2">
                                    <strong>Refund Amount:</strong><br />
                                    @Model.ReturnRequest.ResolutionAmount.Value.ToString("C")
                                </p>
                            }
                            @if (Model.ReturnRequest.ResolvedAt.HasValue)
                            {
                                <p class="mb-2">
                                    <strong>Resolved On:</strong><br />
                                    @Model.ReturnRequest.ResolvedAt.Value.ToString("MMM dd, yyyy HH:mm")
                                </p>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.ReturnRequest.ResolutionNotes))
                            {
                                <p class="mb-0">
                                    <strong>Resolution Notes:</strong><br />
                                    @Model.ReturnRequest.ResolutionNotes
                                </p>
                            }
                            @if (Model.ReturnRequest.Refund != null)
                            {
                                <hr />
                                <p class="mb-0">
                                    <strong>Refund Status:</strong><br />
                                    @await Html.PartialAsync("_RefundStatusBadge", Model.ReturnRequest.Refund.Status)
                                </p>
                            }
                        </div>
                    </div>
                }
                else if (Model.ReturnRequest.Status == MercatoApp.Models.ReturnStatus.Requested)
                {
                    <!-- Actions Card for Requested status -->
                    <div class="card mb-4 border-warning">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-hand-thumbs-up"></i> Actions Required
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">This case is pending your review. Please choose an action:</p>
                            
                            <!-- Resolve Case Button (Primary Action) -->
                            <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#resolveModal">
                                <i class="bi bi-check-square"></i> Resolve Case
                            </button>

                            <!-- Legacy Actions -->
                            <div class="border-top pt-2 mt-2">
                                <p class="text-muted small mb-2">Or use quick actions:</p>
                                <!-- Approve Button -->
                                <button type="button" class="btn btn-success btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#approveModal">
                                    <i class="bi bi-check-circle"></i> Approve Return
                                </button>

                                <!-- Reject Button -->
                                <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                    <i class="bi bi-x-circle"></i> Reject Return
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else if (Model.ReturnRequest.Status == MercatoApp.Models.ReturnStatus.Approved)
                {
                    <!-- Actions Card for Approved status -->
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle"></i> Approved - Awaiting Items
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">You have approved this return. Waiting for the buyer to ship the items back.</p>
                            
                            <!-- Resolve Case Button -->
                            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#resolveModal">
                                <i class="bi bi-check-square"></i> Resolve Case
                            </button>
                        </div>
                    </div>
                }

                <!-- Order Context -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bag-check"></i> Order Context
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Order:</strong><br />
                            <a asp-page="/Seller/OrderDetails" asp-route-id="@Model.ReturnRequest.SubOrder.Id">
                                @Model.ReturnRequest.SubOrder.SubOrderNumber
                            </a>
                        </p>
                        <p class="mb-2">
                            <strong>Order Status:</strong><br />
                            @await Html.PartialAsync("_OrderStatusBadge", Model.ReturnRequest.SubOrder.Status)
                        </p>
                        <p class="mb-2">
                            <strong>Order Total:</strong><br />
                            @Model.ReturnRequest.SubOrder.TotalAmount.ToString("C")
                        </p>
                        @if (!string.IsNullOrWhiteSpace(Model.ReturnRequest.SubOrder.TrackingNumber))
                        {
                            <p class="mb-0">
                                <strong>Tracking:</strong><br />
                                @Model.ReturnRequest.SubOrder.TrackingNumber
                            </p>
                        }
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> Timeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="timeline">
                            <li class="mb-3">
                                <i class="bi bi-circle-fill text-primary"></i>
                                <strong>Case Created</strong><br />
                                <small class="text-muted">@Model.ReturnRequest.RequestedAt.ToString("MMM dd, yyyy HH:mm")</small>
                            </li>
                            @if (Model.ReturnRequest.ApprovedAt.HasValue)
                            {
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    <strong>Approved</strong><br />
                                    <small class="text-muted">@Model.ReturnRequest.ApprovedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </li>
                            }
                            @if (Model.ReturnRequest.RejectedAt.HasValue)
                            {
                                <li class="mb-3">
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                    <strong>Rejected</strong><br />
                                    <small class="text-muted">@Model.ReturnRequest.RejectedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </li>
                            }
                            @if (Model.ReturnRequest.ResolvedAt.HasValue)
                            {
                                <li class="mb-3">
                                    <i class="bi bi-check-square-fill text-success"></i>
                                    <strong>Resolved</strong><br />
                                    <small class="text-muted">@Model.ReturnRequest.ResolvedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </li>
                            }
                            @if (Model.ReturnRequest.CompletedAt.HasValue)
                            {
                                <li>
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    <strong>Completed</strong><br />
                                    <small class="text-muted">@Model.ReturnRequest.CompletedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approve Modal -->
        <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" asp-page-handler="Approve">
                        <input type="hidden" name="returnRequestId" value="@Model.ReturnRequest.Id" />
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="approveModalLabel">
                                <i class="bi bi-check-circle"></i> Approve Return Request
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to approve this return request?</p>
                            <p class="mb-3">The buyer will be notified and can proceed with returning the items. The refund amount will be <strong>@Model.ReturnRequest.RefundAmount.ToString("C")</strong>.</p>
                            
                            <div class="mb-3">
                                <label for="approveNotes" class="form-label">Optional Notes to Buyer</label>
                                <textarea class="form-control" id="approveNotes" name="sellerNotes" rows="3" maxlength="1000" aria-describedby="approveNotesHelp" placeholder="Add any instructions for the buyer (e.g., return shipping address)"></textarea>
                                <small id="approveNotesHelp" class="text-muted">Max 1000 characters</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Approve Return
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reject Modal -->
        <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" asp-page-handler="Reject">
                        <input type="hidden" name="returnRequestId" value="@Model.ReturnRequest.Id" />
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="rejectModalLabel">
                                <i class="bi bi-x-circle"></i> Reject Return Request
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to reject this return request?</p>
                            <p class="mb-3 text-danger">This action will notify the buyer that their request has been denied.</p>
                            
                            <div class="mb-3">
                                <label for="rejectNotes" class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="rejectNotes" name="sellerNotes" rows="4" maxlength="1000" required aria-required="true" aria-describedby="rejectNotesHelp" placeholder="Please explain why you are rejecting this request"></textarea>
                                <small id="rejectNotesHelp" class="text-muted">Required. Max 1000 characters</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-x-circle"></i> Reject Return
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resolve Case Modal -->
        <div class="modal fade" id="resolveModal" tabindex="-1" aria-labelledby="resolveModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form method="post" asp-page-handler="Resolve" id="resolveForm">
                        <input type="hidden" name="returnRequestId" value="@Model.ReturnRequest.Id" />
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="resolveModalLabel">
                                <i class="bi bi-check-square"></i> Resolve Case
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-4">Choose how to resolve this @(Model.ReturnRequest.RequestType == MercatoApp.Models.ReturnRequestType.Complaint ? "complaint" : "return") case. Your decision will be final and the buyer will be notified.</p>
                            
                            <!-- Resolution Type Selection -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Resolution Type <span class="text-danger">*</span></label>
                                <div class="list-group">
                                    <label class="list-group-item">
                                        <input class="form-check-input me-2" type="radio" name="resolutionType" value="@((int)MercatoApp.Models.ResolutionType.FullRefund)" required>
                                        <strong>Full Refund</strong> - Refund the entire amount (@Model.ReturnRequest.RefundAmount.ToString("C"))
                                        <p class="mb-0 text-muted small">Money will be returned to buyer, and a refund transaction will be initiated.</p>
                                    </label>
                                    <label class="list-group-item">
                                        <input class="form-check-input me-2" type="radio" name="resolutionType" value="@((int)MercatoApp.Models.ResolutionType.PartialRefund)" required>
                                        <strong>Partial Refund</strong> - Refund a portion of the amount
                                        <p class="mb-0 text-muted small">Specify the exact amount to refund below.</p>
                                    </label>
                                    <label class="list-group-item">
                                        <input class="form-check-input me-2" type="radio" name="resolutionType" value="@((int)MercatoApp.Models.ResolutionType.Replacement)" required>
                                        <strong>Replacement</strong> - Send a replacement item
                                        <p class="mb-0 text-muted small">No refund. You will send a replacement item.</p>
                                    </label>
                                    <label class="list-group-item">
                                        <input class="form-check-input me-2" type="radio" name="resolutionType" value="@((int)MercatoApp.Models.ResolutionType.Repair)" required>
                                        <strong>Repair</strong> - Repair the item
                                        <p class="mb-0 text-muted small">No refund. Item will be repaired and returned to buyer.</p>
                                    </label>
                                    <label class="list-group-item">
                                        <input class="form-check-input me-2" type="radio" name="resolutionType" value="@((int)MercatoApp.Models.ResolutionType.NoRefund)" required>
                                        <strong>No Refund</strong> - Reject the request
                                        <p class="mb-0 text-muted small">Case will be closed without compensation.</p>
                                    </label>
                                </div>
                            </div>

                            <!-- Partial Refund Amount (shown only when partial refund selected) -->
                            <div class="mb-3 d-none" id="partialRefundAmountDiv">
                                <label for="resolutionAmount" class="form-label fw-bold">
                                    Refund Amount <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="resolutionAmount" 
                                           name="resolutionAmount" 
                                           step="0.01" 
                                           min="0.01" 
                                           max="@Model.ReturnRequest.RefundAmount.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)" 
                                           placeholder="0.00">
                                </div>
                                <small class="text-muted">Maximum refundable: @Model.ReturnRequest.RefundAmount.ToString("C")</small>
                            </div>

                            <!-- Resolution Notes -->
                            <div class="mb-3">
                                <label for="resolutionNotes" class="form-label fw-bold">
                                    Resolution Notes <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" 
                                          id="resolutionNotes" 
                                          name="resolutionNotes" 
                                          rows="4" 
                                          maxlength="2000" 
                                          required 
                                          aria-describedby="resolutionNotesHelp" 
                                          placeholder="Explain your decision and any next steps for the buyer"></textarea>
                                <small id="resolutionNotesHelp" class="text-muted">Required. Provide a clear explanation of your decision. Max 2000 characters</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-square"></i> Resolve Case
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <style>
        .timeline {
            list-style: none;
            padding-left: 20px;
        }
        .timeline li {
            position: relative;
        }
        .timeline li i {
            position: absolute;
            left: -20px;
            top: 2px;
        }
    </style>
    
    <script>
        // Show/hide partial refund amount field based on resolution type selection
        document.addEventListener('DOMContentLoaded', function() {
            const resolutionTypeInputs = document.querySelectorAll('input[name="resolutionType"]');
            const partialRefundAmountDiv = document.getElementById('partialRefundAmountDiv');
            const resolutionAmountInput = document.getElementById('resolutionAmount');
            
            resolutionTypeInputs.forEach(function(input) {
                input.addEventListener('change', function() {
                    const selectedValue = parseInt(this.value);
                    const partialRefundValue = @((int)MercatoApp.Models.ResolutionType.PartialRefund);
                    
                    if (selectedValue === partialRefundValue) {
                        partialRefundAmountDiv.classList.remove('d-none');
                        resolutionAmountInput.setAttribute('required', 'required');
                    } else {
                        partialRefundAmountDiv.classList.add('d-none');
                        resolutionAmountInput.removeAttribute('required');
                        resolutionAmountInput.value = '';
                    }
                });
            });
        });
    </script>
}
