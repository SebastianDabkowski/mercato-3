╔══════════════════════════════════════════════════════════════════════════════════╗
║                   WEB PUSH NOTIFICATIONS - ARCHITECTURE                          ║
╚══════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USER INTERACTION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────────┘

    User Logs In → Permission Banner Appears → User Clicks "Enable"
         │                                              │
         │                                              ▼
         │                                   Browser Permission Prompt
         │                                              │
         │                                              ▼
         │                                    User Grants Permission
         │                                              │
         └──────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                          SUBSCRIPTION REGISTRATION                               │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │   Client-Side    │         │   Service Worker │         │   Push Service   │
    │  (push-notif.js) │         │                  │         │  (Browser Vendor)│
    └────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
             │                            │                            │
             │  1. Register SW            │                            │
             ├───────────────────────────>│                            │
             │                            │                            │
             │  2. Subscribe to Push      │                            │
             ├───────────────────────────>│                            │
             │                            │  3. Create Subscription    │
             │                            ├──────────────────────────>│
             │                            │  4. Return Subscription    │
             │                            │<──────────────────────────┤
             │  5. Subscription Object    │                            │
             │<───────────────────────────┤                            │
             │                            │                            │

    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │   Client-Side    │         │   Backend API    │         │    Database      │
    └────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
             │                            │                            │
             │  6. POST /Api/Push/Subscribe                           │
             │  { endpoint, keys }        │                            │
             ├───────────────────────────>│  7. Save Subscription      │
             │                            ├──────────────────────────>│
             │                            │  8. Confirm Save           │
             │                            │<──────────────────────────┤
             │  9. { success: true }      │                            │
             │<───────────────────────────┤                            │
             │                            │                            │

┌─────────────────────────────────────────────────────────────────────────────────┐
│                        NOTIFICATION DELIVERY FLOW                                │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │  App Event       │         │ NotificationSvc  │         │ PushNotifSvc     │
    │  (Order, etc)    │         │                  │         │                  │
    └────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
             │                            │                            │
             │  1. Trigger Event          │                            │
             │  (e.g., Order Placed)      │                            │
             ├───────────────────────────>│                            │
             │                            │  2. Create Notification    │
             │                            │  (DB + In-App)             │
             │                            │                            │
             │                            │  3. Send Push Notification │
             │                            ├──────────────────────────>│
             │                            │                            │

    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │ PushNotifSvc     │         │   Push Service   │         │  Service Worker  │
    └────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
             │                            │                            │
             │  4. Send with VAPID        │                            │
             │  { title, body, url }      │                            │
             ├───────────────────────────>│                            │
             │                            │  5. Deliver Push Event     │
             │                            ├──────────────────────────>│
             │                            │                            │  6. Show
             │                            │                            │  Notification
             │                            │                            │
             │                            │                            │
    ┌──────────────────┐                                      ┌────────▼─────────┐
    │      User        │◀─────────────────────────────────────│  Browser Shows   │
    │   (Device/OS)    │     7. Display Notification          │   Notification   │
    └──────────────────┘                                      └──────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                      NOTIFICATION CLICK HANDLING                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

    User Clicks Notification → Service Worker Handles Click → Opens/Focuses Browser
                  │                        │                           │
                  │                        ▼                           │
                  │              Parse notification.data.url           │
                  │                        │                           │
                  │                        ▼                           │
                  │              Check for existing tab                │
                  │                        │                           │
                  │                        ├─ Found? → Focus tab       │
                  │                        │                           │
                  │                        └─ Not found? → Open new tab│
                  │                                                    │
                  └────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            COMPONENT DIAGRAM                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────────────────────────────────────┐
    │                              FRONTEND                                      │
    │                                                                            │
    │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐│
    │  │  Permission      │  │  Service Worker  │  │  Push Notification Mgr   ││
    │  │  Banner UI       │  │  (Background)    │  │  (Client-side JS)        ││
    │  │  - Shows prompt  │  │  - Handles push  │  │  - Requests permission   ││
    │  │  - Enable/Later  │  │  - Shows notif   │  │  - Manages subscription  ││
    │  │  - Success msg   │  │  - Click handler │  │  - API communication     ││
    │  └──────────────────┘  └──────────────────┘  └──────────────────────────┘│
    └────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ HTTPS/API
                                        ▼
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                              BACKEND                                       │
    │                                                                            │
    │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐│
    │  │  API Endpoints   │  │  Services        │  │  Models                  ││
    │  │  - Subscribe     │  │  - PushNotifSvc  │  │  - PushSubscription      ││
    │  │  - Unsubscribe   │  │  - NotifService  │  │  - Notification          ││
    │  │  - Status        │  │  - Integration   │  │                          ││
    │  └──────────────────┘  └──────────────────┘  └──────────────────────────┘│
    │                                  │                         │              │
    │                                  └─────────────────────────┘              │
    │                                            ▼                               │
    │                           ┌──────────────────────────┐                    │
    │                           │      Database            │                    │
    │                           │  - PushSubscriptions     │                    │
    │                           │  - Notifications         │                    │
    │                           └──────────────────────────┘                    │
    └────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Web Push Protocol (VAPID)
                                        ▼
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                       EXTERNAL SERVICES                                    │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐ │
    │  │  Browser Push Services (FCM, APNs, etc.)                             │ │
    │  │  - Receives push requests from backend                               │ │
    │  │  - Delivers to user's device                                         │ │
    │  │  - Handles offline queuing                                           │ │
    │  └──────────────────────────────────────────────────────────────────────┘ │
    └────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            SECURITY LAYERS                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

    Layer 1: User Authentication
             └─ All API endpoints require authenticated user
    
    Layer 2: VAPID Authentication  
             └─ Server cryptographically signs push messages
    
    Layer 3: End-to-End Encryption
             └─ Push payload encrypted with p256dh/auth keys
    
    Layer 4: User Isolation
             └─ Users can only manage their own subscriptions
    
    Layer 5: Subscription Validation
             └─ Invalid subscriptions automatically deactivated

═════════════════════════════════════════════════════════════════════════════════
                              IMPLEMENTATION COMPLETE ✅
═════════════════════════════════════════════════════════════════════════════════
